# SPDX-FileCopyrightText: Â© 2021 ChiselStrike <info@chiselstrike.com>

# RUN: CHISEL="@chisel" CURL="@curl" sh -e @file

cat << EOF | $CHISEL type import -
type Person {
  first_name: String
  last_name: String
}
EOF

# CHECK: Type defined: Person

cat << EOF | $CHISEL end-point create ins -
async function chisel(req) {
    if (req.method == 'POST') {
        const payload = await req.json();
        await Chisel.store('Person', payload);
        return new Response('ok\n');
    }
    return new Response('ignored\n');
}
EOF

# CHECK: End point defined: /ins

$CURL --data '{"first_name":"Glauber", "last_name":"Costa"}' -o - localhost:3000/ins

# CHECK: ok

cat << EOF | $CHISEL end-point create find -
async function chisel(req) {
    let response = "";
    let people = await Chisel.find_all("Person");
    for await (let person of people) {
        response += person.first_name + " " + person.last_name;
        response += " ";
    }
    return new Response(response);
}
EOF

# CHECK: End point defined: /find

$CURL -o - localhost:3000/find

# CHECK: HTTP/1.1 200 OK
# CHECK: Glauber Costa
