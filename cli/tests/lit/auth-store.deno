# SPDX-FileCopyrightText: Â© 2021 ChiselStrike <info@chiselstrike.com>

# RUN: sh -e @file

$CURL $CHISELD_HOST/__chiselstrike/auth/callback?user=alice
$CURL $CHISELD_HOST/__chiselstrike/auth/callback?user=bob
$CURL $CHISELD_HOST/__chiselstrike/auth/callback?user=charlie

cat << EOF > "$TEMPDIR/endpoints/users.ts"
export default async function chisel(req: Request) {
    let response = "";
    let users = await Chisel.OAuthUser.cursor().toArray();
    let usernames = users.map(user => user.username);
    usernames.sort();
    for (let u of usernames) {
        response += u + " ";
    }
    return new Response(response + '.');
}
EOF

cd "$TEMPDIR"
$CHISEL apply
$CURL $CHISELD_HOST/dev/users
# CHECK: alice bob charlie .

## Reproduces #708:
$CURL $CHISELD_HOST/__chiselstrike/auth/callback?user=bob
$CURL $CHISELD_HOST/dev/users
# CHECK: alice bob charlie .

## Reproduces #710:
token=`$CURL -s $CHISELD_HOST/__chiselstrike/auth/callback?user=thoroughly-unique-username|sed -ne "s/.*chiselstrike_token=//" -e "s/<.*//p"`
$CURL -H "ChiselStrikeToken:$token" $CHISELD_HOST/__chiselstrike/auth/user
# CHECK: HTTP/1.1 200 OK
# CHECK: thoroughly-unique-username
