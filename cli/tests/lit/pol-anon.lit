# SPDX-FileCopyrightText: Â© 2021 ChiselStrike <info@chiselstrike.com>

# RUN: sh -e @file

mkdir -p "$TEMPDIR/types" "$TEMPDIR/endpoints" "$TEMPDIR/policies"
cp examples/person.graphql "$TEMPDIR/types"
cp examples/store.js "$TEMPDIR/endpoints/ins.js"
cp examples/find.js "$TEMPDIR/endpoints/"

cd "$TEMPDIR"
$CHISEL apply

# CHECK: Type defined: Person
# CHECK: End point defined: /find
# CHECK: End point defined: /ins

$CURL --data '{
    "first_name":"hello", 
    "last_name":"world", 
    "age": 2147483647, 
    "human": false, 
    "height": 12742333
}' -o - $CHISELD_HOST/ins

# CHECK: ok

$CURL -o - $CHISELD_HOST/find

# CHECK: HTTP/1.1 200 OK
# CHECK: hello world 2147483647 false 12742333

cat << EOF > "$TEMPDIR/policies/pol.yaml"
labels:
  - name: pii
    transform: anonymize
EOF
$CHISEL apply

$CURL -o - $CHISELD_HOST/find

# CHECK: HTTP/1.1 200 OK
# CHECK: hello xxxxx

cat << EOF > "$TEMPDIR/types/person.graphql"
type Person {
  first_name: String @L1 @L2 @L3
  last_name: String @pii @L2
  age: Int @L1
  human: Boolean @L1 @L3
  height: Float
}
EOF
$CHISEL apply

cat << EOF > "$TEMPDIR/policies/pol.yaml"
labels:
  - name: Linf
    transform: anonymize
  - name: L1
  - name: L2
    transform: anonymize
EOF
$CHISEL apply

$CURL -o - $CHISELD_HOST/find

# CHECK: HTTP/1.1 200 OK
# CHECK: xxxxx xxxxx

cat << EOF > "$TEMPDIR/policies/pol.yaml"
labels:
  - name: L2
    transform: anonymize
    except_uri: find
EOF
$CHISEL apply

$CURL -o - $CHISELD_HOST/find
# CHECK: HTTP/1.1 200 OK
# CHECK: hello world

cat << EOF > "$TEMPDIR/policies/pol.yaml"
labels:
  - name: L2
    transform: anonymize
    except_uri: d$
EOF
$CHISEL apply

$CURL -o - $CHISELD_HOST/find
# CHECK: HTTP/1.1 200 OK
# CHECK: hello world

cat << EOF > "$TEMPDIR/policies/pol.yaml"
labels:
  - name: L2
    transform: anonymize
    except_uri: ^no_match
EOF
$CHISEL apply

$CURL -o - $CHISELD_HOST/find
# CHECK: HTTP/1.1 200 OK
# CHECK: xxxxx xxxxx
