# SPDX-FileCopyrightText: Â© 2021 ChiselStrike <info@chiselstrike.com>

# RUN: sh -e @file

cd "$TEMPDIR"

cat << EOF > "$TEMPDIR/models/t.ts"
import { ChiselEntity } from "@chiselstrike/api";
export class Bar extends ChiselEntity {
    c: number;
}
export class Foo extends ChiselEntity {
    a?: number;
    b?: Bar;
}
EOF

cat << EOF > "$TEMPDIR/endpoints/save.ts"
import { Foo } from "../models/t.ts";
import { responseFromJson } from "@chiselstrike/api";
export default async function (req: Request) {
    let f = Foo.build(await req.json());
    await f.save();
    return responseFromJson(f);
}
EOF

$CHISEL apply
# CHECK: Model defined: Bar
# CHECK: Model defined: Foo
# CHECK: End point defined: /dev/save

$CURL -d '{}' $CHISELD_HOST/dev/save
# CHECK: HTTP/1.1 200 OK
# CHECK: {"id":
$CURL -d '{"a":142}' $CHISELD_HOST/dev/save
# CHECK: HTTP/1.1 200 OK
# CHECK: "a":142
$CURL -d '{"b":{"c":241}}' $CHISELD_HOST/dev/save
# CHECK: HTTP/1.1 200 OK
# CHECK: "c":241
$CURL -d '{"a":142, "b":{"c":241}}' $CHISELD_HOST/dev/save
# CHECK: HTTP/1.1 200 OK
# CHECK: "c":241

cat << EOF > "$TEMPDIR/models/t.ts"
import { ChiselEntity } from "@chiselstrike/api";
export class Bar extends ChiselEntity {
    c: number;
}
export class Foo extends ChiselEntity {
    a?: number;
    b?: Bar;
    d?: number;
}
EOF

$CHISEL apply
# CHECK: Model defined: Bar
# CHECK: Model defined: Foo
# CHECK: End point defined: /dev/save
